---
phase: 07-agent-orchestrator-selection
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/db/schema.rs
  - backend/src/db/models.rs
  - backend/src/db/mod.rs
  - backend/src/api/sessions.rs
autonomous: true

must_haves:
  truths:
    - "Database sessions table has orchestrator column with 'ralph' default"
    - "Session struct includes orchestrator field"
    - "CreateSessionRequest accepts optional orchestrator parameter"
    - "Backend validates orchestrator enum values"
    - "Existing sessions migrate with 'ralph' as orchestrator"
  artifacts:
    - path: "backend/src/db/schema.rs"
      provides: "MIGRATION_V2 with ALTER TABLE for orchestrator column"
      contains: "MIGRATION_V2"
    - path: "backend/src/db/models.rs"
      provides: "Orchestrator enum with Ralph/Gsd/Gastown variants"
      contains: "pub enum Orchestrator"
    - path: "backend/src/db/mod.rs"
      provides: "Updated insert_session with orchestrator parameter"
      contains: "orchestrator"
    - path: "backend/src/api/sessions.rs"
      provides: "Extended CreateSessionRequest with orchestrator field"
      contains: "orchestrator: Orchestrator"
  key_links:
    - from: "backend/src/api/sessions.rs"
      to: "backend/src/db/mod.rs"
      via: "insert_session call with orchestrator"
      pattern: "insert_session.*orchestrator"
    - from: "backend/src/db/mod.rs"
      to: "backend/src/db/models.rs"
      via: "Orchestrator enum import"
      pattern: "use models.*Orchestrator"
---

<objective>
Add orchestrator field to session database schema and backend API.

Purpose: Enable per-session orchestrator selection persisted to database. This is the foundation for users to choose which agent runs their session.

Output: Backend supports creating sessions with orchestrator, defaulting to "ralph". Existing sessions migrate with ralph as default.
</objective>

<context>
@.planning/phases/07-agent-orchestrator-selection/07-RESEARCH.md

# Existing backend files
@backend/src/db/schema.rs
@backend/src/db/models.rs
@backend/src/db/mod.rs
@backend/src/api/sessions.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Orchestrator enum and update Session model</name>
  <files>
    backend/src/db/models.rs
  </files>
  <action>
Add Orchestrator enum following the existing SessionStatus pattern:

```rust
/// Orchestrator type for agent selection
#[derive(Debug, Clone, Copy, PartialEq, Eq, Serialize, Deserialize)]
#[serde(rename_all = "lowercase")]
pub enum Orchestrator {
    Ralph,
    Gsd,
    Gastown,
}

impl Orchestrator {
    pub fn as_str(&self) -> &'static str {
        match self {
            Orchestrator::Ralph => "ralph",
            Orchestrator::Gsd => "gsd",
            Orchestrator::Gastown => "gastown",
        }
    }

    pub fn from_str(s: &str) -> Result<Self, String> {
        match s {
            "ralph" => Ok(Orchestrator::Ralph),
            "gsd" => Ok(Orchestrator::Gsd),
            "gastown" => Ok(Orchestrator::Gastown),
            _ => Err(format!("invalid orchestrator: '{}'", s)),
        }
    }
}
```

Update Session struct to include orchestrator field (add between name and status):
```rust
pub struct Session {
    pub id: Uuid,
    pub repo_id: Uuid,
    pub name: Option<String>,
    pub orchestrator: Orchestrator,  // NEW
    pub status: SessionStatus,
    pub created_at: DateTime<Utc>,
    pub updated_at: DateTime<Utc>,
}
```
  </action>
  <verify>
`cargo check --package ralphtown-backend` compiles without errors
  </verify>
  <done>
Orchestrator enum exists with Ralph/Gsd/Gastown variants. Session struct has orchestrator field.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add database migration and update queries</name>
  <files>
    backend/src/db/schema.rs
    backend/src/db/mod.rs
  </files>
  <action>
In schema.rs:
1. Bump SCHEMA_VERSION from 1 to 2
2. Add migration SQL constant:
```rust
/// Migration from v1 to v2: Add orchestrator column to sessions
pub const MIGRATION_V1_TO_V2: &str = r#"
ALTER TABLE sessions ADD COLUMN orchestrator TEXT NOT NULL DEFAULT 'ralph';
"#;
```

In mod.rs:
1. Import Orchestrator from models (add to existing use statement)
2. Update init_schema() to apply migration when upgrading from v1:
   - After checking current_version, if current < 2 and >= 1, run MIGRATION_V1_TO_V2
3. Update insert_session signature: `pub fn insert_session(&self, repo_id: Uuid, name: Option<&str>, orchestrator: Orchestrator) -> DbResult<Session>`
4. Update insert_session SQL to include orchestrator:
```rust
conn.execute(
    "INSERT INTO sessions (id, repo_id, name, orchestrator, status, created_at, updated_at) VALUES (?1, ?2, ?3, ?4, ?5, ?6, ?7)",
    params![
        id.to_string(),
        repo_id.to_string(),
        name,
        orchestrator.as_str(),
        SessionStatus::Idle.as_str(),
        now.to_rfc3339(),
        now.to_rfc3339()
    ],
)?;
```
5. Update insert_session return to include orchestrator in Session struct
6. Update get_session, list_sessions, list_sessions_by_repo queries:
   - SELECT must include orchestrator column (add after name, before status)
   - Row parsing must parse orchestrator using parse_enum
7. Update test functions that call insert_session to pass Orchestrator::Ralph as third argument

Import the migration constant in mod.rs from schema module.
  </action>
  <verify>
`cargo test --package ralphtown-backend` - all tests pass including existing session tests
  </verify>
  <done>
Schema version is 2. Migration adds orchestrator column. All session CRUD operations include orchestrator field.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update API sessions endpoint</name>
  <files>
    backend/src/api/sessions.rs
  </files>
  <action>
1. Import Orchestrator from db::models (add to existing use statement)
2. Update CreateSessionRequest:
```rust
#[derive(Debug, Deserialize, Serialize)]
pub struct CreateSessionRequest {
    pub repo_id: Uuid,
    pub name: Option<String>,
    #[serde(default = "default_orchestrator")]
    pub orchestrator: Orchestrator,
}

fn default_orchestrator() -> Orchestrator {
    Orchestrator::Ralph
}
```
3. Update create_session handler to pass orchestrator to db.insert_session:
```rust
let session = state
    .db
    .insert_session(req.repo_id, req.name.as_deref(), req.orchestrator)
    .map_err(|e| AppError::Internal(e.to_string()))?;
```
4. Update run_session to check orchestrator and return error for unsupported ones:
```rust
// After getting session, before getting repo:
if session.orchestrator != Orchestrator::Ralph {
    return Err(AppError::BadRequest(format!(
        "Orchestrator '{}' is not yet supported. Only 'ralph' is available.",
        session.orchestrator.as_str()
    )));
}
```
5. Update test functions that create sessions to include orchestrator in request or use default
  </action>
  <verify>
`cargo test --package ralphtown-backend` - all tests pass
`curl -X POST http://localhost:8080/api/sessions -H "Content-Type: application/json" -d '{"repo_id":"...", "orchestrator":"gsd"}'` returns 400 error about unsupported orchestrator
  </verify>
  <done>
CreateSessionRequest accepts orchestrator with ralph as default. Non-ralph orchestrators return 400 error on run.
  </done>
</task>

</tasks>

<verification>
1. Build: `cargo build --package ralphtown-backend` succeeds
2. Tests: `cargo test --package ralphtown-backend` all pass
3. Migration: Start backend, check SQLite schema has orchestrator column
4. API: Create session without orchestrator field - defaults to ralph
5. API: Create session with orchestrator: "ralph" - works
6. API: Create session with orchestrator: "gsd" - saves, but run returns error
7. API: Create session with invalid orchestrator - returns validation error
</verification>

<success_criteria>
- Orchestrator enum has Ralph, Gsd, Gastown variants
- Session struct includes orchestrator field
- Database migration adds orchestrator column with 'ralph' default
- CreateSessionRequest accepts optional orchestrator (defaults to ralph)
- run_session rejects non-ralph orchestrators with helpful message
- All existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/07-agent-orchestrator-selection/07-01-SUMMARY.md`
</output>
