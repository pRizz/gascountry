---
phase: 04-error-handling
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - frontend/src/api/types.ts
  - frontend/src/components/ralphtown/CloneDialog.tsx
  - frontend/src/hooks/useCloneProgress.ts
autonomous: true

must_haves:
  truths:
    - "User sees help_steps listed below error message in clone dialog"
    - "SSH auth errors show SSH-specific troubleshooting steps"
    - "HTTPS auth errors show PAT-related troubleshooting steps"
    - "Error toast includes expandable details when help_steps present"
  artifacts:
    - path: "frontend/src/api/types.ts"
      provides: "ErrorResponse type with help_steps field"
      contains: "help_steps"
    - path: "frontend/src/components/ralphtown/CloneDialog.tsx"
      provides: "Error display with help_steps rendering"
      contains: "help_steps"
  key_links:
    - from: "frontend/src/hooks/useCloneProgress.ts"
      to: "frontend/src/api/types.ts"
      via: "CloneProgressEvent error type"
      pattern: "help_steps"
---

<objective>
Update frontend to display help_steps from backend error responses, giving users actionable guidance when clone operations fail.

Purpose: Backend now returns structured errors with help_steps. Frontend needs to parse and display these so users see specific troubleshooting guidance.

Output: Enhanced CloneDialog that shows help_steps, updated API types, improved error handling in useCloneProgress hook.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-error-handling/04-RESEARCH.md
@.planning/phases/04-error-handling/04-01-PLAN.md
@frontend/src/api/types.ts
@frontend/src/api/client.ts
@frontend/src/components/ralphtown/CloneDialog.tsx
@frontend/src/hooks/useCloneProgress.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update API types for help_steps</name>
  <files>
    - frontend/src/api/types.ts
  </files>
  <action>
1. Add an ErrorResponse type to represent structured backend errors:
   ```typescript
   export interface ErrorResponse {
     error: {
       code: string;
       message: string;
       details?: unknown;
       help_steps?: string[];
     };
   }
   ```

2. Update CloneProgressEvent error variant to include help_steps:
   ```typescript
   export type CloneProgressEvent =
     | { type: "progress"; data: CloneProgress }
     | { type: "complete"; data: { repo: Repo; message: string } }
     | { type: "error"; data: { message: string; help_steps?: string[] } };
   ```

3. Add a helper type for parsed clone errors:
   ```typescript
   export interface CloneErrorInfo {
     message: string;
     code?: string;
     help_steps?: string[];
   }
   ```
  </action>
  <verify>
    - `npm run typecheck` in frontend/ passes
    - No TypeScript errors in types.ts
  </verify>
  <done>
    - ErrorResponse type exists with help_steps field
    - CloneProgressEvent error variant includes optional help_steps
    - CloneErrorInfo helper type defined
  </done>
</task>

<task type="auto">
  <name>Task 2: Update useCloneProgress hook to parse help_steps</name>
  <files>
    - frontend/src/hooks/useCloneProgress.ts
  </files>
  <action>
1. Update the hook's onError callback signature to include help_steps:
   ```typescript
   interface UseCloneProgressOptions {
     onProgress?: (progress: CloneProgress) => void;
     onComplete?: (repo: Repo, message: string) => void;
     onError?: (message: string, helpSteps?: string[]) => void; // Updated signature
   }
   ```

2. Update the SSE message parsing for error events to extract help_steps:
   - When parsing error events from SSE, check for help_steps in the data
   - Pass help_steps to onError callback

3. Example parsing update:
   ```typescript
   // In the message handler for "error" event type
   if (eventData.type === "error") {
     const { message, help_steps } = eventData.data;
     onErrorRef.current?.(message, help_steps);
   }
   ```
  </action>
  <verify>
    - `npm run typecheck` in frontend/ passes
    - Hook compiles without errors
  </verify>
  <done>
    - onError callback receives optional help_steps array
    - SSE error parsing extracts help_steps from backend response
  </done>
</task>

<task type="auto">
  <name>Task 3: Update CloneDialog to display help_steps</name>
  <files>
    - frontend/src/components/ralphtown/CloneDialog.tsx
  </files>
  <action>
1. Add state to track error details including help_steps:
   ```typescript
   const [errorInfo, setErrorInfo] = useState<{
     message: string;
     helpSteps?: string[];
   } | null>(null);
   ```

2. Update the useCloneProgress onError handler:
   ```typescript
   onError: (message, helpSteps) => {
     setIsCloning(false);
     setCloneProgress(null);
     setErrorInfo({ message, helpSteps });
     // Keep toast for notification, but details shown in dialog
     toast({
       title: "Failed to clone repository",
       description: message,
       variant: "destructive",
     });
   },
   ```

3. Clear errorInfo when starting a new clone or closing dialog:
   ```typescript
   const handleClone = () => {
     // ... existing validation
     setErrorInfo(null); // Clear previous error
     setIsCloning(true);
     startClone(trimmedUrl);
   };

   const handleOpenChange = (newOpen: boolean) => {
     if (!newOpen) {
       // ... existing cleanup
       setErrorInfo(null);
     }
     // ...
   };
   ```

4. Add error display section to the dialog content, after the progress section:
   ```tsx
   {errorInfo && (
     <div className="mt-4 p-3 bg-destructive/10 border border-destructive/20 rounded-md">
       <p className="text-sm font-medium text-destructive mb-2">
         {errorInfo.message}
       </p>
       {errorInfo.helpSteps && errorInfo.helpSteps.length > 0 && (
         <div className="space-y-1">
           <p className="text-xs font-medium text-muted-foreground">
             Troubleshooting steps:
           </p>
           <ul className="text-xs text-muted-foreground list-disc list-inside space-y-0.5">
             {errorInfo.helpSteps.map((step, index) => (
               <li key={index}>{step}</li>
             ))}
           </ul>
         </div>
       )}
     </div>
   )}
   ```

5. Update the Clone button to be re-enabled after error so user can retry:
   - Button should be disabled only during active cloning, not after error
   ```tsx
   <Button onClick={handleClone} disabled={isCloning}>
     {isCloning ? "Cloning..." : "Clone"}
   </Button>
   ```
  </action>
  <verify>
    - `npm run typecheck` in frontend/ passes
    - `npm run build` in frontend/ succeeds
    - Manual test: try cloning a private SSH repo without keys configured, verify help_steps appear in dialog
  </verify>
  <done>
    - Error info displayed in dialog with styled error box
    - Help steps rendered as a bulleted list
    - Error persists in dialog until dismissed or retry
    - Clone button re-enabled after error for retry
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run typecheck` passes in frontend/
2. `npm run build` passes in frontend/
3. Start the app and attempt to clone `git@github.com:private/repo.git` without SSH keys
4. Verify dialog shows error message with SSH-specific help_steps listed
5. Verify user can click Clone again to retry after error
6. Verify closing and reopening dialog clears error state
</verification>

<success_criteria>
- [ ] ErrorResponse type includes help_steps field
- [ ] useCloneProgress passes help_steps to onError callback
- [ ] CloneDialog displays error message prominently
- [ ] CloneDialog renders help_steps as bulleted list when present
- [ ] Error state clears on dialog close or new clone attempt
- [ ] Clone button enabled for retry after error
</success_criteria>

<output>
After completion, create `.planning/phases/04-error-handling/04-02-SUMMARY.md`
</output>
