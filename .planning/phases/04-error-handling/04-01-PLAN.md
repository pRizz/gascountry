---
phase: 04-error-handling
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/Cargo.toml
  - backend/src/error.rs
  - backend/src/git/mod.rs
  - backend/src/ralph/mod.rs
  - backend/src/api/repos.rs
autonomous: true

must_haves:
  truths:
    - "SSH clone failure includes help_steps explaining SSH key setup"
    - "HTTPS clone failure includes help_steps explaining PAT requirements"
    - "Ralph spawn failure on NOT_FOUND includes help_steps about installation"
    - "Structured error responses include help_steps array when actionable"
  artifacts:
    - path: "backend/src/error.rs"
      provides: "AppError::UserActionRequired with help_steps field"
      contains: "help_steps"
    - path: "backend/src/git/mod.rs"
      provides: "CloneError enum with SSH/HTTPS auth classification"
      contains: "SshAuthFailed"
    - path: "backend/src/ralph/mod.rs"
      provides: "RalphError::NotFound with help_steps"
      contains: "NotFound"
  key_links:
    - from: "backend/src/api/repos.rs"
      to: "backend/src/error.rs"
      via: "CloneError conversion to AppError"
      pattern: "impl From<CloneError> for AppError"
---

<objective>
Enhance backend error handling to classify git authentication failures (SSH vs HTTPS) and provide actionable help_steps in structured error responses.

Purpose: Users currently see generic "Clone failed" errors. After this plan, errors will include specific troubleshooting guidance based on the failure type.

Output: Enhanced error types in error.rs, git/mod.rs, and ralph/mod.rs with help_steps in API responses.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-error-handling/04-RESEARCH.md
@backend/src/error.rs
@backend/src/git/mod.rs
@backend/src/ralph/mod.rs
@backend/src/api/repos.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add which crate and enhance error types</name>
  <files>
    - backend/Cargo.toml
    - backend/src/error.rs
    - backend/src/git/mod.rs
    - backend/src/ralph/mod.rs
  </files>
  <action>
1. Add `which = "7"` to backend/Cargo.toml dependencies.

2. In backend/src/error.rs:
   - Add a new `AppError::UserActionRequired` variant:
     ```rust
     UserActionRequired {
         code: String,
         message: String,
         details: Option<serde_json::Value>,
         help_steps: Vec<String>,
     },
     ```
   - Add `help_steps` field to ErrorBody struct:
     ```rust
     #[serde(skip_serializing_if = "Vec::is_empty")]
     help_steps: Vec<String>,
     ```
   - Update IntoResponse impl to handle UserActionRequired (use 422 status).
   - Update Display impl for UserActionRequired.

3. In backend/src/git/mod.rs:
   - Add a new `CloneError` enum with variants:
     ```rust
     #[derive(Debug, Error)]
     pub enum CloneError {
         #[error("SSH authentication failed: {message}")]
         SshAuthFailed { message: String, help_steps: Vec<String> },

         #[error("HTTPS authentication failed: {message}")]
         HttpsAuthFailed { message: String, help_steps: Vec<String> },

         #[error("Network error: {message}")]
         NetworkError { message: String },

         #[error("Clone operation failed: {message}")]
         OperationFailed { message: String },
     }
     ```
   - Add `fn classify_clone_error(err: git2::Error) -> CloneError` that:
     - Uses `err.class()` to check for `git2::ErrorClass::Ssh` -> SshAuthFailed
     - Uses `err.class()` to check for `git2::ErrorClass::Http` -> HttpsAuthFailed
     - Uses `err.class()` to check for `git2::ErrorClass::Net` -> NetworkError
     - Falls back to OperationFailed for other cases
     - SSH help_steps: ["Ensure your SSH key is added to ssh-agent: ssh-add ~/.ssh/id_ed25519", "Verify your key is added to GitHub: ssh -T git@github.com", "If using a passphrase, the ssh-agent must have the key unlocked"]
     - HTTPS help_steps: ["HTTPS cloning requires a Personal Access Token (PAT)", "Create a PAT at GitHub Settings > Developer Settings > Tokens", "Use the PAT as password when prompted, or configure git credential helper"]
   - Update `clone()` and `clone_with_progress()` to return `Result<git2::Repository, CloneError>`.

4. In backend/src/ralph/mod.rs:
   - Add a new variant `NotFound { message: String, help_steps: Vec<String> }` to RalphError.
   - Update the spawn error handling to detect `std::io::ErrorKind::NotFound`:
     ```rust
     let mut child = cmd.spawn().map_err(|e| {
         if e.kind() == std::io::ErrorKind::NotFound {
             RalphError::NotFound {
                 message: "ralph CLI not found in PATH".to_string(),
                 help_steps: vec![
                     "Install ralph: cargo install ralph".to_string(),
                     "Or download from release page".to_string(),
                     "Ensure ~/.cargo/bin is in your PATH".to_string(),
                     "Restart your terminal after installation".to_string(),
                 ],
             }
         } else {
             RalphError::SpawnFailed(e.to_string())
         }
     })?;
     ```
  </action>
  <verify>
    - `cargo check -p ralphtown` compiles without errors
    - `cargo test -p ralphtown` passes all existing tests
  </verify>
  <done>
    - CloneError enum exists with SshAuthFailed, HttpsAuthFailed variants containing help_steps
    - classify_clone_error function uses git2::ErrorClass for classification
    - RalphError::NotFound variant exists with help_steps
    - AppError::UserActionRequired variant exists with help_steps field
    - ErrorBody includes help_steps in serialized JSON
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire clone errors to API responses with help_steps</name>
  <files>
    - backend/src/api/repos.rs
    - backend/src/error.rs
  </files>
  <action>
1. In backend/src/error.rs:
   - Add `impl From<CloneError> for AppError`:
     ```rust
     impl From<crate::git::CloneError> for AppError {
         fn from(err: crate::git::CloneError) -> Self {
             match err {
                 crate::git::CloneError::SshAuthFailed { message, help_steps } => {
                     AppError::UserActionRequired {
                         code: "SSH_AUTH_FAILED".to_string(),
                         message,
                         details: None,
                         help_steps,
                     }
                 }
                 crate::git::CloneError::HttpsAuthFailed { message, help_steps } => {
                     AppError::UserActionRequired {
                         code: "HTTPS_AUTH_FAILED".to_string(),
                         message,
                         details: None,
                         help_steps,
                     }
                 }
                 crate::git::CloneError::NetworkError { message } => {
                     AppError::Internal(format!("Network error: {}", message))
                 }
                 crate::git::CloneError::OperationFailed { message } => {
                     AppError::Internal(format!("Clone failed: {}", message))
                 }
             }
         }
     }
     ```
   - Add `impl From<RalphError> for AppError` (if not exists) that converts NotFound to UserActionRequired.

2. In backend/src/api/repos.rs:
   - Update `clone_repo` and `clone_with_progress_sse` handlers:
     - Change git clone calls from `GitManager::clone()` to use classify_clone_error
     - In clone_repo: Replace the existing `.map_err(|e| AppError::Internal(...))` with `.map_err(|e| AppError::from(classify_clone_error(e)))?` when the git2 operation fails
     - Actually, since clone() now returns CloneError, just use `?` and let the From impl handle it
   - Update the SSE error_sse helper to include help_steps in CloneEvent::Error if available

3. Update CloneEvent::Error in repos.rs to optionally include help_steps:
   ```rust
   Error {
       message: String,
       #[serde(skip_serializing_if = "Vec::is_empty", default)]
       help_steps: Vec<String>,
   },
   ```
  </action>
  <verify>
    - `cargo check -p ralphtown` compiles
    - `cargo test -p ralphtown` passes
    - Test manually: attempt to clone a private repo without auth configured - should return structured error with help_steps in response body
  </verify>
  <done>
    - Clone failures to private repos return UserActionRequired with code SSH_AUTH_FAILED or HTTPS_AUTH_FAILED
    - Error response JSON includes help_steps array
    - SSE clone errors include help_steps when available
  </done>
</task>

<task type="auto">
  <name>Task 3: Add repo path validation with helpful errors</name>
  <files>
    - backend/src/api/repos.rs
    - backend/src/git/mod.rs
  </files>
  <action>
1. In backend/src/git/mod.rs:
   - Add a validation function:
     ```rust
     /// Validate that a repo path exists and is a valid git repository.
     /// Returns a user-friendly error if validation fails.
     pub fn validate_repo_path(path: &Path) -> Result<(), AppError> {
         if !path.exists() {
             return Err(AppError::UserActionRequired {
                 code: "REPO_PATH_NOT_FOUND".to_string(),
                 message: format!("Repository path no longer exists: {}", path.display()),
                 details: None,
                 help_steps: vec![
                     "The folder may have been moved or deleted".to_string(),
                     "Check if the path exists on disk".to_string(),
                     format!("Expected location: {}", path.display()),
                     "Remove and re-add the repository if the path has changed".to_string(),
                 ],
             });
         }
         if !path.join(".git").exists() && git2::Repository::open(path).is_err() {
             return Err(AppError::UserActionRequired {
                 code: "NOT_A_GIT_REPO".to_string(),
                 message: format!("Path exists but is not a git repository: {}", path.display()),
                 details: None,
                 help_steps: vec![
                     "This folder does not contain a .git directory".to_string(),
                     "Initialize with: git init".to_string(),
                     "Or clone a repository to this location".to_string(),
                 ],
             });
         }
         Ok(())
     }
     ```
   - Note: This requires importing AppError, so add `use crate::error::AppError;` at the top

2. In backend/src/api/repos.rs:
   - In the add_repo handler, use validate_repo_path instead of the current inline checks.
   - Keep the existing checks for path.exists() and Repository::open() but convert them to use the new validation.

3. Write a test for validate_repo_path:
   - Test with non-existent path -> REPO_PATH_NOT_FOUND error with help_steps
   - Test with existing non-git directory -> NOT_A_GIT_REPO error with help_steps
   - Test with valid git repo -> Ok(())
  </action>
  <verify>
    - `cargo check -p ralphtown` compiles
    - `cargo test -p ralphtown` passes including new validation tests
    - Manually test: add a repo with invalid path, confirm error response includes help_steps
  </verify>
  <done>
    - validate_repo_path function exists and returns AppError::UserActionRequired for invalid paths
    - Error includes specific help_steps based on failure type (not found vs not a git repo)
    - Existing tests still pass
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `cargo check -p ralphtown` compiles without warnings
2. `cargo test -p ralphtown` all tests pass
3. Attempt clone of private SSH repo without keys -> error with SSH help_steps
4. Attempt clone of private HTTPS repo without PAT -> error with HTTPS help_steps
5. Add repo with non-existent path -> error with path help_steps
6. Add repo with existing non-git folder -> error with "not a git repo" help_steps
</verification>

<success_criteria>
- [ ] CloneError enum classifies git2 errors by SSH/HTTPS/Network
- [ ] AppError::UserActionRequired includes help_steps array
- [ ] API error responses serialize help_steps to JSON
- [ ] RalphError::NotFound detects missing ralph CLI with helpful message
- [ ] Repo path validation returns actionable errors
- [ ] All existing tests continue to pass
</success_criteria>

<output>
After completion, create `.planning/phases/04-error-handling/04-01-SUMMARY.md`
</output>
