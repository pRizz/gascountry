---
phase: 03-clone-progress
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - frontend/src/api/types.ts
  - frontend/src/hooks/useCloneProgress.ts
  - frontend/src/components/ralphtown/CloneDialog.tsx
autonomous: true

must_haves:
  truths:
    - "User sees progress bar updating during clone operation"
    - "User sees object count and bytes downloaded during clone"
    - "User can distinguish cloning state from complete state"
    - "Progress UI shows both download and indexing phases"
  artifacts:
    - path: "frontend/src/api/types.ts"
      provides: "CloneProgress type definition"
      contains: "interface CloneProgress"
    - path: "frontend/src/hooks/useCloneProgress.ts"
      provides: "useCloneProgress hook for SSE subscription"
      contains: "export function useCloneProgress"
    - path: "frontend/src/components/ralphtown/CloneDialog.tsx"
      provides: "Progress component display during clone"
      contains: "Progress"
  key_links:
    - from: "frontend/src/hooks/useCloneProgress.ts"
      to: "/api/repos/clone-progress"
      via: "EventSource connection"
      pattern: "EventSource.*clone-progress"
    - from: "frontend/src/components/ralphtown/CloneDialog.tsx"
      to: "frontend/src/hooks/useCloneProgress.ts"
      via: "hook import and usage"
      pattern: "useCloneProgress"
---

<objective>
Add progress UI to CloneDialog using SSE subscription hook and Progress component.

Purpose: Display real-time clone progress to users so they see feedback during clone operations.
Output: CloneDialog shows Progress bar with object counts and byte progress during clone.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-clone-progress/03-RESEARCH.md
@.planning/phases/03-clone-progress/03-01-SUMMARY.md

@frontend/src/api/types.ts
@frontend/src/api/hooks.ts
@frontend/src/hooks/useWebSocket.ts
@frontend/src/components/ralphtown/CloneDialog.tsx
@frontend/src/components/ui/progress.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add CloneProgress type to API types</name>
  <files>frontend/src/api/types.ts</files>
  <action>
Add CloneProgress interface matching backend struct:

export interface CloneProgress {
  received_objects: number;
  total_objects: number;
  received_bytes: number;
  indexed_objects: number;
  total_deltas: number;
  indexed_deltas: number;
}

Add CloneProgressEvent union type for SSE events:

export type CloneProgressEvent =
  | { type: "progress"; data: CloneProgress }
  | { type: "complete"; data: { repo: Repo; message: string } }
  | { type: "error"; data: { message: string } };

Place these in the Repos section of the file, near CloneRepoRequest/CloneRepoResponse.
  </action>
  <verify>npm run type-check --prefix frontend</verify>
  <done>CloneProgress and CloneProgressEvent types exist and type-check passes</done>
</task>

<task type="auto">
  <name>Task 2: Create useCloneProgress hook</name>
  <files>frontend/src/hooks/useCloneProgress.ts</files>
  <action>
Create new hook file with SSE subscription logic:

1. Import types: CloneProgress, Repo from "@/api/types"
2. Import useRef, useCallback, useEffect from "react"
3. Import useQueryClient from "@tanstack/react-query" for cache invalidation
4. Import queryKeys from "@/api/hooks"

Create interface UseCloneProgressOptions:
- onProgress: (progress: CloneProgress) => void
- onComplete: (repo: Repo, message: string) => void
- onError: (message: string) => void

Create useCloneProgress hook that:
1. Stores EventSource ref: useRef<EventSource | null>(null)
2. Gets queryClient for invalidation

3. Creates startClone(url: string) callback:
   - Close any existing EventSource
   - Create new EventSource with URL: `/api/repos/clone-progress?url=${encodeURIComponent(url)}`
   - Set onmessage handler to parse JSON and call onProgress
   - Add "complete" event listener: parse JSON, call onComplete, invalidate repos query, close EventSource
   - Add "error" event listener: call onError, close EventSource
   - Store in ref

4. Creates cancel() callback to close EventSource and set ref to null

5. useEffect cleanup to close EventSource on unmount

6. Return { startClone, cancel }

Follow existing hook patterns from useWebSocket.ts for structure and naming.
  </action>
  <verify>npm run type-check --prefix frontend</verify>
  <done>useCloneProgress hook exists with startClone/cancel functions, type-checks successfully</done>
</task>

<task type="auto">
  <name>Task 3: Update CloneDialog with progress UI</name>
  <files>frontend/src/components/ralphtown/CloneDialog.tsx</files>
  <action>
Update CloneDialog to show progress during clone:

1. Add imports:
   - import { Progress } from "@/components/ui/progress"
   - import { useCloneProgress } from "@/hooks/useCloneProgress"
   - import type { CloneProgress } from "@/api/types"

2. Add state for progress:
   - const [cloneProgress, setCloneProgress] = useState<CloneProgress | null>(null)
   - const [isCloning, setIsCloning] = useState(false)

3. Set up useCloneProgress hook with callbacks:
   - onProgress: setCloneProgress
   - onComplete: (repo, message) => { setIsCloning(false); setCloneProgress(null); onCloneSuccess(repo); show success toast; close dialog }
   - onError: (message) => { setIsCloning(false); setCloneProgress(null); show error toast }

4. Update handleClone to:
   - Set isCloning(true)
   - Call startClone(trimmedUrl) instead of cloneRepo.mutateAsync
   - Remove the old try/catch block (SSE handles success/error)

5. Add progress display below the URL input (when isCloning):
   - Calculate percentage: (received_objects / total_objects) * 100
   - Show Progress component with value={percentage}
   - Show text: "Downloading: {received_objects} / {total_objects} objects ({formatBytes(received_bytes)})"
   - When indexing (received_objects === total_objects but indexed_deltas < total_deltas):
     Show "Indexing: {indexed_deltas} / {total_deltas} deltas"

6. Add formatBytes helper function:
   const formatBytes = (bytes: number): string => {
     if (bytes < 1024) return `${bytes} B`;
     if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`;
     return `${(bytes / (1024 * 1024)).toFixed(1)} MB`;
   };

7. Update button disabled state to use isCloning instead of cloneRepo.isPending
8. Update button text: isCloning ? "Cloning..." : "Clone"
9. Update Cancel button disabled state to isCloning
10. Remove useCloneRepo hook usage (no longer needed for progress clone)

Keep the dialog structure and styling consistent with existing pattern.
  </action>
  <verify>npm run type-check --prefix frontend && npm run build --prefix frontend</verify>
  <done>CloneDialog shows Progress bar during clone, displays object counts and bytes, handles complete/error states</done>
</task>

</tasks>

<verification>
1. npm run type-check --prefix frontend succeeds
2. npm run build --prefix frontend succeeds
3. CloneProgress type matches backend struct
4. useCloneProgress hook properly manages EventSource lifecycle
5. CloneDialog shows progress bar with percentage during clone
6. Progress text shows object counts and byte counts
7. Dialog closes and shows success toast on completion
8. Error toast shown on clone failure
</verification>

<success_criteria>
- Progress bar appears when clone starts
- Progress updates show object download progress (X / Y objects)
- Progress updates show bytes downloaded
- Indexing phase shown after download completes
- Success toast and dialog close on completion
- Error toast on failure
- No memory leaks (EventSource closed on unmount/completion)
</success_criteria>

<output>
After completion, create `.planning/phases/03-clone-progress/03-02-SUMMARY.md`
</output>
