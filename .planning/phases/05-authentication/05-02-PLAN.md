---
phase: 05-authentication
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - frontend/src/api/types.ts
  - frontend/src/hooks/useCloneProgress.ts
  - frontend/src/components/ralphtown/CloneDialog.tsx
autonomous: true

must_haves:
  truths:
    - "User sees PAT input when GitHub HTTPS clone fails auth"
    - "User sees username/password inputs when non-GitHub HTTPS clone fails auth"
    - "User sees passphrase input when SSH clone fails with encrypted key"
    - "Credential inputs show trust messaging explaining credential usage"
    - "CLI alternative instructions are visible as fallback option"
    - "Submitting credentials triggers auto-retry of clone"
  artifacts:
    - path: "frontend/src/api/types.ts"
      provides: "CredentialRequest type with ssh_passphrase, github_pat, https_basic variants"
      contains: "CredentialRequest"
    - path: "frontend/src/hooks/useCloneProgress.ts"
      provides: "Updated hook accepting credentials, POST request"
      contains: "startCloneWithCredentials"
    - path: "frontend/src/components/ralphtown/CloneDialog.tsx"
      provides: "Credential inputs, trust messaging, CLI alternative"
      contains: "CredentialInput"
  key_links:
    - from: "frontend/src/components/ralphtown/CloneDialog.tsx"
      to: "frontend/src/hooks/useCloneProgress.ts"
      via: "startCloneWithCredentials call with credentials"
      pattern: "startCloneWithCredentials.*credentials"
    - from: "frontend/src/hooks/useCloneProgress.ts"
      to: "/api/repos/clone-progress"
      via: "POST fetch with credentials body"
      pattern: "POST.*clone-progress"
---

<objective>
Add credential input UI to CloneDialog for authentication retry with trust messaging and CLI fallback.

Purpose: When clone fails due to authentication, user can enter credentials inline and retry without leaving the dialog.
Output: CloneDialog with conditional credential inputs, trust explanations, and CLI setup alternative.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-authentication/05-CONTEXT.md
@.planning/phases/05-authentication/05-RESEARCH.md
@.planning/phases/05-authentication/05-01-SUMMARY.md
@frontend/src/api/types.ts
@frontend/src/hooks/useCloneProgress.ts
@frontend/src/components/ralphtown/CloneDialog.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add credential types and update hook</name>
  <files>frontend/src/api/types.ts, frontend/src/hooks/useCloneProgress.ts</files>
  <action>
**In frontend/src/api/types.ts:**

Add credential request types that match backend API:
```typescript
// Credential types for clone retry
export type CredentialRequest =
  | { type: "ssh_passphrase"; passphrase: string; key_path?: string }
  | { type: "github_pat"; token: string }
  | { type: "https_basic"; username: string; password: string };

// Auth type hints from backend error response
export type AuthType = "ssh" | "github_pat" | "https_basic";

// Extended clone error info with retry hints
export interface CloneErrorInfo {
  message: string;
  code?: string;
  help_steps?: string[];
  auth_type?: AuthType;
  can_retry_with_credentials?: boolean;
}
```

Update CloneProgressEvent error variant to include new fields:
```typescript
| { type: "error"; data: { message: string; help_steps?: string[]; auth_type?: AuthType; can_retry_with_credentials?: boolean } }
```

**In frontend/src/hooks/useCloneProgress.ts:**

1. Add `startCloneWithCredentials` to the hook return type:
```typescript
export interface UseCloneProgressReturn {
  startClone: (url: string) => void;
  startCloneWithCredentials: (url: string, credentials: CredentialRequest) => void;
  cancel: () => void;
}
```

2. Add `startCloneWithCredentials` function that:
   - Closes any existing EventSource
   - Uses fetch with POST to `/api/repos/clone-progress`
   - Body: `{ url, credentials }`
   - Response is SSE stream, so need to use ReadableStream or EventSource workaround

   Actually, EventSource only supports GET. For POST with SSE:
   - Use `fetch` with POST, then read response.body as stream
   - Parse SSE manually (split by `\n\n`, parse `data:` lines)

   Simpler alternative: Keep EventSource for initial clone (GET), add new fetch-based POST for retry:
```typescript
const startCloneWithCredentials = useCallback(
  async (url: string, credentials: CredentialRequest) => {
    cancel();

    try {
      const response = await fetch("/api/repos/clone-progress", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ url, credentials }),
      });

      if (!response.ok || !response.body) {
        onErrorRef.current("Failed to start clone");
        return;
      }

      const reader = response.body.getReader();
      const decoder = new TextDecoder();
      let buffer = "";

      while (true) {
        const { done, value } = await reader.read();
        if (done) break;

        buffer += decoder.decode(value, { stream: true });
        const lines = buffer.split("\n\n");
        buffer = lines.pop() || "";

        for (const chunk of lines) {
          const dataMatch = chunk.match(/^data: (.+)$/m);
          if (dataMatch) {
            const data = JSON.parse(dataMatch[1]);
            if (data.type === "progress") {
              onProgressRef.current(data);
            } else if (data.type === "complete") {
              queryClient.invalidateQueries({ queryKey: queryKeys.repos });
              onCompleteRef.current(data.repo, data.message);
              return;
            } else if (data.type === "error") {
              onErrorRef.current(data.message, data.help_steps, data.auth_type, data.can_retry_with_credentials);
              return;
            }
          }
        }
      }
    } catch (e) {
      onErrorRef.current("Connection error");
    }
  },
  [cancel, queryClient]
);
```

3. Update onError callback signature to include auth hints:
```typescript
onError: (message: string, helpSteps?: string[], authType?: AuthType, canRetry?: boolean) => void;
```
  </action>
  <verify>npm run type-check passes (or tsc --noEmit), no TypeScript errors</verify>
  <done>Credential types added, useCloneProgress hook supports POST with credentials</done>
</task>

<task type="auto">
  <name>Task 2: Add credential input UI to CloneDialog</name>
  <files>frontend/src/components/ralphtown/CloneDialog.tsx</files>
  <action>
Update CloneDialog with credential input section:

1. Add new state for credential mode:
```typescript
const [credentialMode, setCredentialMode] = useState<AuthType | null>(null);
const [patToken, setPatToken] = useState("");
const [sshPassphrase, setSshPassphrase] = useState("");
const [httpUsername, setHttpUsername] = useState("");
const [httpPassword, setHttpPassword] = useState("");
```

2. Update errorInfo state type and onError callback:
```typescript
const [errorInfo, setErrorInfo] = useState<{
  message: string;
  helpSteps?: string[];
  authType?: AuthType;
  canRetry?: boolean;
} | null>(null);
```

Update the hook usage:
```typescript
onError: (message, helpSteps, authType, canRetry) => {
  setIsCloning(false);
  setCloneProgress(null);
  setErrorInfo({ message, helpSteps, authType, canRetry });
  if (canRetry && authType) {
    setCredentialMode(authType);
  }
  // ... toast
},
```

3. Add credential input section (shown when credentialMode is set):
```tsx
{credentialMode && (
  <div className="space-y-4 mt-4 p-4 border rounded-md bg-muted/50">
    <h4 className="font-medium text-sm">Authentication Required</h4>

    {credentialMode === "github_pat" && (
      <div className="space-y-2">
        <Label htmlFor="pat">GitHub Personal Access Token</Label>
        <Input
          id="pat"
          type="password"
          value={patToken}
          onChange={(e) => setPatToken(e.target.value)}
          placeholder="ghp_xxxxxxxxxxxx"
          disabled={isCloning}
        />
        <p className="text-xs text-muted-foreground">
          Used only for this clone. Not stored.
        </p>
      </div>
    )}

    {credentialMode === "https_basic" && (
      <>
        <div className="space-y-2">
          <Label htmlFor="username">Username</Label>
          <Input
            id="username"
            value={httpUsername}
            onChange={(e) => setHttpUsername(e.target.value)}
            disabled={isCloning}
          />
        </div>
        <div className="space-y-2">
          <Label htmlFor="password">Password</Label>
          <Input
            id="password"
            type="password"
            value={httpPassword}
            onChange={(e) => setHttpPassword(e.target.value)}
            disabled={isCloning}
          />
          <p className="text-xs text-muted-foreground">
            Used only for this clone. Not stored.
          </p>
        </div>
      </>
    )}

    {credentialMode === "ssh" && (
      <div className="space-y-2">
        <Label htmlFor="passphrase">SSH Key Passphrase</Label>
        <Input
          id="passphrase"
          type="password"
          value={sshPassphrase}
          onChange={(e) => setSshPassphrase(e.target.value)}
          placeholder="Enter passphrase for your SSH key"
          disabled={isCloning}
        />
        <p className="text-xs text-muted-foreground">
          Used only for this clone. Not stored.
        </p>
      </div>
    )}

    <Button
      onClick={handleRetryWithCredentials}
      disabled={isCloning || !hasValidCredentials()}
      className="w-full"
    >
      {isCloning ? "Cloning..." : "Retry with Credentials"}
    </Button>
  </div>
)}
```

4. Add handleRetryWithCredentials function:
```typescript
const handleRetryWithCredentials = () => {
  if (!credentialMode) return;

  let credentials: CredentialRequest;
  if (credentialMode === "github_pat") {
    credentials = { type: "github_pat", token: patToken };
  } else if (credentialMode === "https_basic") {
    credentials = { type: "https_basic", username: httpUsername, password: httpPassword };
  } else {
    credentials = { type: "ssh_passphrase", passphrase: sshPassphrase };
  }

  setErrorInfo(null);
  setIsCloning(true);
  startCloneWithCredentials(gitUrl, credentials);
};

const hasValidCredentials = () => {
  if (credentialMode === "github_pat") return patToken.trim().length > 0;
  if (credentialMode === "https_basic") return httpUsername.trim().length > 0 && httpPassword.trim().length > 0;
  if (credentialMode === "ssh") return sshPassphrase.trim().length > 0;
  return false;
};
```

5. Reset credential state when dialog closes or on success:
```typescript
const handleOpenChange = (newOpen: boolean) => {
  // ... existing code
  if (!newOpen) {
    setGitUrl("");
    setErrorInfo(null);
    setCredentialMode(null);
    setPatToken("");
    setSshPassphrase("");
    setHttpUsername("");
    setHttpPassword("");
  }
};
```

Also reset on success in onComplete callback.
  </action>
  <verify>npm run dev starts without errors, CloneDialog renders credential inputs when auth error with canRetry=true</verify>
  <done>Credential inputs appear on auth failure, retry button sends credentials to backend</done>
</task>

<task type="auto">
  <name>Task 3: Add trust messaging and CLI alternative</name>
  <files>frontend/src/components/ralphtown/CloneDialog.tsx</files>
  <action>
Enhance the credential section with trust messaging and CLI alternative:

1. Add collapsible "How are my credentials used?" section using Collapsible component:
```tsx
import {
  Collapsible,
  CollapsibleContent,
  CollapsibleTrigger,
} from "@/components/ui/collapsible";
import { ChevronDown } from "lucide-react";

// Inside the credential section, after the input fields:
<Collapsible className="mt-2">
  <CollapsibleTrigger className="flex items-center text-xs text-muted-foreground hover:text-foreground">
    <ChevronDown className="h-3 w-3 mr-1" />
    How are my credentials used?
  </CollapsibleTrigger>
  <CollapsibleContent className="text-xs text-muted-foreground mt-2 space-y-1">
    <p>Your credentials are:</p>
    <ul className="list-disc list-inside ml-2">
      <li>Sent directly to the git server for authentication</li>
      <li>Used only for this single clone operation</li>
      <li>Never stored on disk or in any database</li>
      <li>Discarded immediately after the clone completes</li>
    </ul>
  </CollapsibleContent>
</Collapsible>
```

2. Add CLI alternative section that's always visible when credential mode is active:
```tsx
{credentialMode && (
  <div className="mt-4 pt-4 border-t">
    <p className="text-xs text-muted-foreground mb-2">
      Prefer to configure credentials via CLI?
    </p>
    <Collapsible>
      <CollapsibleTrigger className="text-xs text-primary hover:underline flex items-center">
        <ChevronDown className="h-3 w-3 mr-1" />
        Show CLI setup instructions
      </CollapsibleTrigger>
      <CollapsibleContent className="mt-2 text-xs bg-muted p-3 rounded font-mono">
        {credentialMode === "ssh" && (
          <>
            <p className="mb-2"># Add your SSH key to ssh-agent:</p>
            <p>ssh-add ~/.ssh/id_ed25519</p>
            <p className="mt-2 mb-2"># Or for RSA keys:</p>
            <p>ssh-add ~/.ssh/id_rsa</p>
          </>
        )}
        {credentialMode === "github_pat" && (
          <>
            <p className="mb-2"># Configure git credential helper:</p>
            <p>git config --global credential.helper store</p>
            <p className="mt-2 mb-2"># Then clone via command line:</p>
            <p>git clone {gitUrl}</p>
            <p className="mt-1 text-muted-foreground"># Enter PAT as password when prompted</p>
          </>
        )}
        {credentialMode === "https_basic" && (
          <>
            <p className="mb-2"># Configure git credential helper:</p>
            <p>git config --global credential.helper store</p>
            <p className="mt-2 mb-2"># Then clone via command line:</p>
            <p>git clone {gitUrl}</p>
          </>
        )}
      </CollapsibleContent>
    </Collapsible>
  </div>
)}
```

3. Add tooltip on password/PAT field for quick trust info:
```tsx
import { Tooltip, TooltipContent, TooltipTrigger } from "@/components/ui/tooltip";
import { Info } from "lucide-react";

// Wrap the label with tooltip:
<div className="flex items-center gap-1">
  <Label htmlFor="pat">GitHub Personal Access Token</Label>
  <Tooltip>
    <TooltipTrigger asChild>
      <Info className="h-3 w-3 text-muted-foreground cursor-help" />
    </TooltipTrigger>
    <TooltipContent>
      <p className="text-xs">Used only for this clone, not stored</p>
    </TooltipContent>
  </Tooltip>
</div>
```

4. Ensure TooltipProvider wraps the dialog content (check if already present in app, if not add):
- If TooltipProvider is not already wrapping the app, wrap the credential input section with it locally

5. Import icons from lucide-react: ChevronDown, Info
  </action>
  <verify>npm run dev, verify collapsible sections work, tooltips appear on hover, CLI instructions are correct</verify>
  <done>Trust messaging with collapsible explanation, CLI alternative instructions visible, tooltips on sensitive fields</done>
</task>

</tasks>

<verification>
All verification passes:
- npm run type-check (no TypeScript errors)
- npm run dev (app starts)
- npm run lint (no lint errors)

Manual verification:
1. Clone public repo - works as before (GET endpoint)
2. Attempt clone of private repo without auth - shows error with help_steps
3. If error includes auth_type, credential inputs appear
4. Enter credentials and click retry - POST with credentials
5. Collapsible trust section expands/collapses
6. CLI alternative shows correct commands
</verification>

<success_criteria>
- AUTH-01: PAT input appears for GitHub HTTPS auth failure (auth_type = "github_pat")
- AUTH-02: Username/password inputs appear for non-GitHub HTTPS (auth_type = "https_basic")
- AUTH-03: Passphrase input appears for SSH auth failure (auth_type = "ssh")
- AUTH-04: Trust messaging explains credential usage (inline text + collapsible detail)
- AUTH-05: CLI alternative instructions visible with setup commands
- Auto-retry works: submitting credentials triggers new clone attempt with POST
</success_criteria>

<output>
After completion, create `.planning/phases/05-authentication/05-02-SUMMARY.md`
</output>
